<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Actor Recovery - Programming with Actors</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Programming with Actors</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="actor-startup-and-ready-state"><a class="header" href="#actor-startup-and-ready-state">Actor Startup and Ready State</a></h1>
<p>Note that larger actor frameworks will provide some form of a <code>persistence</code> module. This should provide all of the functionality needed to restore actors to their original state. However, if you do not have access to a persistent-capable framework, then this page details how recovery works.</p>
<hr />
<p>When an actor is created or restarted, it goes through an initialization phase before it is fully capable of processing regular messages from its mailbox. This phase is crucial for establishing the actor's initial state. For actors that use persistence, this startup phase involves state recovery.</p>
<p>An actor can be thought of as transitioning through distinct <strong>internal states</strong>:</p>
<ul>
<li>
<p><strong>Initializing / Recovering</strong></p>
<p>The actor has been created but is actively loading its past state from a journal or other persistent store. It is not yet ready to handle its primary     operational messages.</p>
</li>
<li>
<p><strong>Ready</strong></p>
<p>The actor has successfully loaded its historical state and is now capable of processing all types of incoming messages according to its main business logic.</p>
</li>
</ul>
<h2 id="the-startup-process-entering-the-initializing-state"><a class="header" href="#the-startup-process-entering-the-initializing-state">The Startup Process: Entering the Initializing State</a></h2>
<p>When a persistent actor instance is spawned by the system, its <code>on_start</code> logic begins. At this point, the actor enters the <strong>Initializing</strong> state. The actor's first task is typically to initiate the recovery process.</p>
<p>This involves:</p>
<ol>
<li>Starting out in an <code>Initializing</code> state.</li>
<li>Sending a specific message to a known "Journal Reader" actor or service, requesting its historical data (events) based on its unique identity.</li>
<li>Potentially sending a similar request to a "Snapshot Store" service if snapshots are used, asking for the latest snapshot.</li>
</ol>
<p>The actor now waits for these recovery messages to arrive in its mailbox.</p>
<h2 id="handling-messages-during-recovery-stashing"><a class="header" href="#handling-messages-during-recovery-stashing">Handling Messages During Recovery: Stashing</a></h2>
<p>Any message sent to the actor's <code>ActorRef</code> will be placed in its mailbox, but this needs to be handled carefully.</p>
<p>Since the actor cannot correctly process regular operational messages until its state is recovered, its <code>handler</code> logic must check its current state. If the actor is <code>Initializing</code> and receives a message that is <em>not</em> part of the recovery process (i.e., not a response from the Journal Reader or Snapshot Store), it must <strong>stash</strong> the message.</p>
<p>Stashing involves:</p>
<ul>
<li>Checking if the actor's current state is <code>Initializing</code>.</li>
<li>If yes, storing the incoming message in a temporary internal collection, like a <code>VecDeque</code> (a double-ended queue), often called the "stash".</li>
<li>Returning from the <code>handler</code> function without processing the message's content against the actor's business logic.</li>
</ul>
<p>Messages related to recovery (like <code>SnapshotLoaded(state, seq_num)</code> or <code>JournalEntry(event, seq_num)</code>) are <em>not</em> stashed; they are processed immediately by the <code>receive</code> function's <code>Initializing</code> state logic to rebuild the actor's state.</p>
<h2 id="replaying-history-and-transitioning-to-ready"><a class="header" href="#replaying-history-and-transitioning-to-ready">Replaying History and Transitioning to Ready</a></h2>
<p>As the actor receives recovery messages from the Journal Reader/Snapshot Store:</p>
<ol>
<li>It applies the loaded snapshot state (if any).</li>
<li>It applies each journaled event in sequence number order, mutating its internal state just as it would for a new incoming command/event.</li>
</ol>
<p>Once the actor has received and applied all historical data (e.g., indicated by a final message from the Journal Reader like <code>RecoveryComplete(last_seq_num)</code>), it knows its state is fully reconstructed. At this moment, the actor performs a critical state transition:</p>
<ul>
<li>It changes its state from <code>Initializing</code> to <code>Ready</code>.</li>
</ul>
<h2 id="processing-stashed-messages-and-new-messages"><a class="header" href="#processing-stashed-messages-and-new-messages">Processing Stashed Messages and New Messages</a></h2>
<p>Upon transitioning to the <code>Ready</code> state, the actor's priority changes:</p>
<ol>
<li>It first processes all messages currently held in its internal "stash". It iterates through the stash and passes each stashed message back to its <code>receive</code> function, this time processing it using the <code>Ready</code> state logic. This ensures messages received during recovery are handled in the order they arrived (relative to each other).</li>
<li>After the stash is empty, the actor proceeds to process any new messages that subsequently arrive in its mailbox, using its <code>Ready</code> state logic.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../persistence/snapshots.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../design_patterns.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../persistence/snapshots.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../design_patterns.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
